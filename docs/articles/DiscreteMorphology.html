<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discrete morphology example • Revticulate</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Discrete morphology example">
<meta property="og:description" content="Revticulate">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Revticulate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BasicTutorial.html">Usage of Revticulate</a>
    </li>
    <li>
      <a href="../articles/DiscreteMorphology.html">Discrete morphology example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Discrete morphology example</h1>
                        <h4 data-toc-skip class="author">Caleb Charpentier and April Wright</h4>
            
            <h4 data-toc-skip class="date">Feb. 20, 2022</h4>
      
      
      <div class="hidden name"><code>DiscreteMorphology.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Revticulate can be installed in two ways. The first is via CRAN, using the default <code>install.packages</code> function in R:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"Revticulate"</span><span class="op">)</span></code></pre></div>
<p>The second is via the remotes package, a lightweight package enabling installation from GitHub repositories.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"revbayes/Revticulate"</span><span class="op">)</span></code></pre></div>
<p>The GitHub repository for Revticulate contains cutting-edge features and may contain bugfixes, but the CRAN is known to be stable for everyday use.</p>
<p>Upon first installation, Revticulate will run a package check.<br>
This check searches for and .Renviron file that contains a RevBayes path. If the package doesn’t find this file, or finds it without the path, the package prompts the user to use <code><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">usethis::edit_r_environ()</a></code>. This opens the .Renviron file, and the user will enter <code>rb={absolute path to revbayes}</code>. This can be edited at any time if there are multiple installs on the system, or if you recompile RevBayes and want to use a new version.</p>
<p>Before using Revticulate in knitr, make sure the following is in your setup chunk:</p>
<pre><code><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">Revticulate</span><span class="op">)</span>
<span class="fu"><a href="../reference/knitRev.html">knitRev</a></span><span class="op">(</span><span class="op">)</span></code></pre>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Morphological data is commonly used for estimating phylogenetic trees from fossils. This tutorial will focus on estimating phylogenetic trees from <em>discrete</em> characters, those characters which can be broken into non-overlapping character states. This type of data has been used for estimation of phylogenetic trees for many years. In the past twenty years, Bayesian methods for estimating phylogeny from this type of data have become increasingly common.</p>
<p>This tutorial will give an overview of common models and assumptions when estimating a tree from discrete morphological data. We will use a dataset from <span class="citation">(<span class="citeproc-not-found" data-reference-id="zamora2013"><strong>???</strong></span>)</span>. This dataset contains 27 extinct echinoderm taxa and 60 binary and multistate characters.</p>
<div class="section level3">
<h3 id="overview-of-discrete-morphology-models">Overview of Discrete Morphology Models<a class="anchor" aria-label="anchor" href="#overview-of-discrete-morphology-models"></a>
</h3>
<p>As technologies for obtaining low-cost and high-throughput nucleotide sequence data have become available, many scientists have become reliant on molecular data for phylogenetics. However, morphological data remain the only direct observations we have of most extinct organisms, and are an independent data source for understanding phylogeny. Many of the phylogenetic methods we will discuss in this tutorial were invented for use with sequence data. However, these methods are still very useful for discrete morphological data. We will examine some common assumptions for modeling data in a phylogenetic context, then move on to look at relaxing these assumptions.</p>
<p>Modeling discrete morphological data requires an understanding of the underlying properties of the data. When we work with molecular data, we know <em>a priori</em> that certain types of changes are more likely than others. For example, changes within a type of base (purine and pyrimidine) are much more likely than changes between types of bases. This information can be used to add parameters to the phylogenetic model. There are no equivalent and generalizable truths across characters in a morphological data matrix. For example, while <code>0</code> and <code>1</code> are commonly coded to “presence” and “absence”, this is not always the case, nor are all characters atomized at the same magnitude. For instance, at one character, changing character states may not reflect a large amount of genetic changes. Theca shape (character 2 in the Zamora et al. 2013 dataset), for example appears quite labile. At another, the changes to the character state may reflect a rearrangement of genetic elements, or might have larger ramifications for the organism’s life and behavior. Character 38, the central plate of the lintel, may be one such character, as it changes seldom.</p>
<p>When we work with morphological data in a Bayesian context, we are performing these analyses after a long history of workers performing phylogenetic analysis in a maximum parsimony framework. Under maximum parsimony, trees are proposed. The number of changes in the data implied by the tree are then counted. The tree implying the fewest changes is considered the best. There may be multiple most parsimonious trees in a dataset. Parsimony has been the dominant method for estimating phylogenetic trees from discrete morphological data. Characters that cannot be used to discriminate between tree topologies are not typically collected by workers using parsimony. For example, characters that do not vary are not collected, as they all have the same length (0 steps) on a tree. Likewise, autapomorphies are typically not collected. As we will see later, this has ramifications for how we model the data.</p>
<p><img src="Mk_model.png" width="800"> Graphical model showing the Mk model (left panel) and corresponding Rev code (right panel).</p>
<p>For many years, parsimony was the only way to estimate a phylogenetic tree from morphological data. In 2001, Paul Lewis published the Mk model of morphological evolution. The Mk model <span class="citation">(Lewis 2001)</span> is a generalization of the Jukes-Cantor model <span class="citation">(Jukes and Cantor 1969)</span> of nucleotide sequence evolution. This model, while simple, has allowed researchers to access the toolkit of phylogenetic methods available to researchers working with other discretely-valued data, such as nucleotides or amino acids.</p>
<div class="section level4">
<h4 id="the-mk-model">The Mk Model<a class="anchor" aria-label="anchor" href="#the-mk-model"></a>
</h4>
<p>As mentioned above, the Mk model is a generalization of the JC model. This model assumes that all transitions between character states are equal, and that all characters in the matrix have the same transition matrix. The transition matrix for a binary trait looks like so:</p>
<p><span class="math display">\[Q = \begin{pmatrix} -\mu_0 &amp; \mu_{01} \\
\mu_{10} &amp; -\mu_1  &amp;\\
\end{pmatrix} \mbox{  ,}\]</span></p>
<p>In this matrix, <span class="math inline">\(\mu\)</span> represents the transition probability between the two states that follow it. A transition matrix for multistate data simply expands.</p>
<p><span class="math display">\[Q = \begin{pmatrix} -\mu_0 &amp; \mu_{01} &amp; \mu_{02} &amp; \mu_{03} \\
\mu_{10} &amp; -\mu_1  &amp; \mu_{12} &amp; \mu_{13} \\
\mu_{20} &amp; \mu_{21} &amp; -\mu_2  &amp; \mu_{23} \\
\mu_{30} &amp; \mu_{31} &amp; \mu_{32} &amp; -\mu_3
\end{pmatrix} \mbox{  ,}\]</span></p>
<p>However, the Mk model sets transitions to be equal from any state to any other state. In that sense, our multistate matrix really looks like this:</p>
<p><span class="math display">\[Q = \begin{pmatrix} -(k-1)\mu &amp; \mu &amp; \mu &amp; \mu \\
\mu &amp; -(k-1)\mu  &amp; \mu &amp; \mu \\
\mu &amp; \mu &amp; -(k-1)\mu  &amp; \mu \\
\mu &amp; \mu &amp; \mu &amp; -(k-1)\mu \\
\end{pmatrix} \mbox{  ,}\]</span></p>
<p>You might notice that these transition rates are not different than what we might expect from an equal-weights parsimony matrix. In practice, the Mk model makes very few assumptions due to the complexity and non-generalizability of morphological data.</p>
<p>This model may strike some readers as too simplistic to be adequate for morphological data. However, Bayesian methods are less likely to be mislead by homoplasy than is parsimony <span class="citation">(Felsenstein 1985)</span>. More recent work has demonstrated that the model outperforms parsimony in many situations, particularly those in which there is high homoplasy <span class="citation">(Wright and Hillis 2014)</span>, with empirical work demonstrating that it fits many datasets reasonably well <span class="citation">(Wright, Lloyd, and Hillis 2016)</span>.</p>
<p>In the first part of this tutorial, we will estimate a tree under the Mk model as proposed by Lewis (2001). We will then relax core parameters of the model.</p>
<p>{% subsubsection Ascertainment Bias %}</p>
<p>One remaining component of the model we have not yet discussed is ascertainment bias. Because workers using parsimony do not collect invariant characters and seldom collect autapomorphies, our data are <em>biased</em>. Imagine, for a moment, that you were to measure the average height in a room. But first, you asked the 10 shortest people to leave. Your estimate of the average height would be too tall! In effect, this happens in the morphological data, as well. Because the characters with the fewest changes are not collected, we over estimate the amount of evolutionary change on the tree. At the time of publication, Lewis (2001) also included a correction factor for this bias.</p>
<p>These original corrections involved simulating parsimony non-informative characters along each proposed tree. These would be used to normalize the likelihood value. While this procedure is statistically valid, it is a bit slow. There are multiple ways to perform this correction <span class="citation">(Allman and Rhodes 2008)</span>. RevBayes uses a dynamic likelihood approach to avoid repeated simulations.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="example-inferring-a-phylogeny-of-extinct-cinctans-using-the-mk-model">Example: Inferring a Phylogeny of Extinct Cinctans Using the Mk Model<a class="anchor" aria-label="anchor" href="#example-inferring-a-phylogeny-of-extinct-cinctans-using-the-mk-model"></a>
</h2>
<div class="section level3">
<h3 id="tutorial-format">Tutorial Format<a class="anchor" aria-label="anchor" href="#tutorial-format"></a>
</h3>
<p>This tutorial follows a specific format for issuing instructions and information.</p>
<blockquote>
<p>The boxed instructions guide you to complete tasks that are not part of the RevBayes syntax, but rather direct you to create directories or files or similar.</p>
</blockquote>
<p>Information describing the commands and instructions will be written in paragraph-form before or after they are issued.</p>
<p>All command-line text, including all Rev syntax, are given in <code>monotype font</code>. Furthermore, blocks of Rev code that are needed to build the model, specify the analysis, or execute the run are given in separate shaded boxes. For example, we will instruct you to create a constant node called <code>example</code> that is equal to <code>1.0</code> using the <code>&lt;-</code> operator like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">example</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>
<span class="va">example</span></code></pre></div>
<pre><code><span class="co">## [1] 1</span></code></pre>
<p>It is important to be aware that some PDF viewers may render some characters given as differently. Thus, if you copy and paste text from this PDF, you may introduce some incorrect characters. Because of this, we recommend that you type the instructions in this tutorial or copy them from the scripts provided.</p>
</div>
<div class="section level3">
<h3 id="data-and-files">Data and Files<a class="anchor" aria-label="anchor" href="#data-and-files"></a>
</h3>
<div class="section level4">
<h4 id="creating-rev-files">Creating Rev Files<a class="anchor" aria-label="anchor" href="#creating-rev-files"></a>
</h4>
<blockquote>
<p>In this exercise, we will build Rev scripts via the R Revticulate package.</p>
</blockquote>
</div>
</div>
<div class="section level3">
<h3 id="load-data-matrices">Load Data Matrices<a class="anchor" aria-label="anchor" href="#load-data-matrices"></a>
</h3>
<p>RevBayes uses the function <code>readDiscreteCharacterData()</code> to load a data matrix to the workspace from a formatted file. This function can be used for both molecular sequences and discrete morphological characters. Import the morphological character matrix and assign it the variable <code>morpho</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clearRev.html">clearRev</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Successfully reset Rev History!</span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">morpho</span> <span class="op">&lt;-</span> <span class="fu">readDiscreteCharacterData</span><span class="op">(</span><span class="st">"Cinctans.nex"</span><span class="op">)</span>
<span class="va">morpho</span></code></pre></div>
<pre><code><span class="co">## [1] "Successfully read one character matrix from file 'Cinctans.nex'"</span>
<span class="co">## [2] "Standard character matrix with 27 taxa and 60 characters"       </span>
<span class="co">## [3] "========================================================"       </span>
<span class="co">## [4] "Origination: Cinctans.nex"                                      </span>
<span class="co">## [5] "Number of taxa: 27"                                             </span>
<span class="co">## [6] "Number of included taxa: 27"                                    </span>
<span class="co">## [7] "Number of characters: 60"                                       </span>
<span class="co">## [8] "Number of included characters: 60"                              </span>
<span class="co">## [9] "Datatype: Standard"</span></code></pre>
<div class="section level4">
<h4 id="create-helper-variables">Create Helper Variables<a class="anchor" aria-label="anchor" href="#create-helper-variables"></a>
</h4>
<p>We will dig into the model momentarily. But first, we will create some variables that are used in our analysis, but are not parameters. We will assign these variables with the constant node assignment operator, <code>&lt;-</code>. Even though these values are used in our scripts, they are not parameters of the model.</p>
<p>We will first create a constant node called <code>num_taxa</code> that is equal to the number of species in our analysis (27). We will also create a constant node called <code>num_branches</code> representing the number of branches in the tree, and one of the taxon names. This list will be used to initialize the tree.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">num_taxa</span> <span class="op">&lt;-</span> <span class="fu">morpho.size</span><span class="op">(</span><span class="op">)</span>
<span class="va">num_branches</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">num_taxa</span> <span class="op">-</span> <span class="fl">2</span>
<span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu">morpho.names</span><span class="op">(</span><span class="op">)</span>
<span class="va">taxa</span></code></pre></div>
<pre><code><span class="co">## [1] "[ Ctenocystis_utahensis, Gyrocystis_platessa, Gyrocystis_testudiformis, Gyrocystis_cruzae, Gyrocystis_badulesiensis, Gyrocystis_erecta,"             </span>
<span class="co">## [2] "Progyrocystis_disjuncta, Protocinctus_mansillaensis, Elliptocinctus_barrandei, Elliptocinctus_vizcainoi, Sucocystis_theronensis, Sucocystis_bretoni,"</span>
<span class="co">## [3] "Lignanicystis_barriosensis, Undatacinctus_undata, Sucocystis_acrofera, Undatacinctus_quadricornuta, Undatacinctus_melendezi, Asturicystis_jaekeli,"  </span>
<span class="co">## [4] "Sotocinctus_ubaghsi, Trochocystites_bohemicus, Trochocystoides_parvus, Ludwigicinctus_truncatus, Graciacystis_ambigua, Asturicystis_havliceki,"      </span>
<span class="co">## [5] "Nelegerocystis_ivantzovi, Rozanovicystis_triangularis, Davidocinctus_pembrokensis ]"</span></code></pre>
<p>Next, create a workspace variable called <code>moves</code>, a vector containing all of the MCMC moves used to propose new states for every stochastic node in the model graph.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">moves</span> <span class="op">=</span> <span class="fu">VectorMoves</span><span class="op">(</span><span class="op">)</span>
<span class="va">monitors</span> <span class="op">=</span> <span class="fu">VectorMonitors</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>One important distinction here is that <code>moves</code> is part of the RevBayes workspace and not the hierarchical model. Thus, we use the workspace assignment operator <code>=</code> instead of the constant node assignment <code>&lt;-</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="the-fossilized-birth-death-process">The Fossilized Birth-Death Process<a class="anchor" aria-label="anchor" href="#the-fossilized-birth-death-process"></a>
</h3>
<div class="section level4">
<h4 id="speciation-and-extinction-rates">Speciation and Extinction Rates<a class="anchor" aria-label="anchor" href="#speciation-and-extinction-rates"></a>
</h4>
<p>We will begin by specifying the speciation and extinction rates. These parameters govern the rate at which lineages are added to and removed from the population. From a previous study we know that an expoential distribution with a parameter of 1.471 is a reasonable distribution in which this value could lie.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">speciation_rate</span> <span class="op">~</span> <span class="fu">dnExponential</span><span class="op">(</span><span class="fl">1.471</span><span class="op">)</span>

  <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">speciation_rate</span>, lambda<span class="op">=</span><span class="fl">0.01</span>, weight<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>;
  <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">speciation_rate</span>, lambda<span class="op">=</span><span class="fl">0.10</span>, weight<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>;
  <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">speciation_rate</span>, lambda<span class="op">=</span><span class="fl">1.00</span>, weight<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>;</code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>It is possible to set extinction as its own parameter, for example, like so:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">extinction_rate</span> <span class="op">~</span> <span class="fu">dnExponential</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>However, extinction and speciation rates are often correlated. And so we will instantiate a parameter called turnover, which is the ratio of extinction rate to speciation rate ($ $ / $ $). The parameters to this lognormal distribution were arrived at by simulation of parameter values from the data.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">turnover</span> <span class="op">~</span> <span class="fu">dnLognormal</span><span class="op">(</span><span class="fl">0.945</span>, <span class="fl">1.926745</span><span class="op">)</span>;
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">turnover</span>, delta<span class="op">=</span><span class="fl">0.01</span>, weight<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">turnover</span>, delta<span class="op">=</span><span class="fl">0.10</span>, weight<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">turnover</span>, delta<span class="op">=</span><span class="fl">1.00</span>, weight<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>As discussed in previous lessons, moves specify how often (<em>weight</em>), we will sample new values for the parameters in our model. The <em>delta</em> of the slide move specifies how different from the initial value a propsed new parameter will be. More information on moves can be found in the <a href="https://revbayes.github.io/tutorials/mcmc/binomial.html" class="external-link">MCMC tutorial</a>.</p>
<p>Once our turnover is defined, we can also monitor our extinction values like so:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">extinction_rate</span> <span class="op">:=</span> <span class="va">turnover</span><span class="op">*</span><span class="va">speciation_rate</span>
    <span class="va">diversification</span> <span class="op">:=</span> <span class="va">speciation_rate</span> <span class="op">-</span> <span class="va">extinction_rate</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Next, we will define the sampling in the present. Cinctans are extinct. We will rescale our times such that the last appearance of Cinctans in the fossil record is the ‘present’. Previous studies indicate that about half of Cinctans that existed them are in this analysis <span class="citation">(<span class="citeproc-not-found" data-reference-id="zamora2013"><strong>???</strong></span>)</span>. We will treat $ $ as a known quantity, a constant node. We will therefore, not specify any moves on this parameter.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">.506</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Our data is made up of fossils. We also need to define the rate at which fossils are recovered on the tree. This is the fossil sampling rate (<span class="math inline">\(\psi\)</span> in Fig. 3). This is also referred to in the literature as the <code>recovery</code> rate. Prior research indicates that an exponential distribution with parameter 3.892 should be adequate.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">psi</span> <span class="op">~</span> <span class="fu">dnExponential</span><span class="op">(</span><span class="fl">3.892</span><span class="op">)</span> 
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">psi</span>, lambda<span class="op">=</span><span class="fl">0.01</span>, weight<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">psi</span>, lambda<span class="op">=</span><span class="fl">0.1</span>,  weight<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">psi</span>, lambda<span class="op">=</span><span class="fl">1</span>,    weight<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>If you do not have a good intution for what this distribution looks like, you can visualize it below.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">## Attaching package: 'ggplot2'</span></code></pre>
<pre><code><span class="co">## The following object is masked from 'package:Revticulate':</span>
<span class="co">## </span>
<span class="co">##     %+%</span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">3.891</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></code></pre></div>
<p><img src="DiscreteMorphology_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="the-origin-time">The Origin Time<a class="anchor" aria-label="anchor" href="#the-origin-time"></a>
</h4>
<p>Finally, we need to define an origin time for the Cinctan group. Because we are rescaling the analysis to the treat the ‘present’ as last observation of Cinctans, our origin time will be drawn from a uniform distribution between 10.2 and 15.2 mya. In actuality, this corresponds to 508 to 513 million years ago.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="va">origin_time</span> <span class="op">~</span> <span class="fu">dnUnif</span><span class="op">(</span><span class="fl">10.2</span>, <span class="fl">15.2</span><span class="op">)</span>;
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">origin_time</span>, delta<span class="op">=</span><span class="fl">0.01</span>, weight<span class="op">=</span><span class="fl">5.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">origin_time</span>, delta<span class="op">=</span><span class="fl">0.1</span>,  weight<span class="op">=</span><span class="fl">5.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvSlide</span><span class="op">(</span><span class="va">origin_time</span>, delta<span class="op">=</span><span class="fl">1</span>,    weight<span class="op">=</span><span class="fl">5.0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
</div>
<div class="section level4">
<h4 id="the-fbd-distribution-object">The FBD Distribution Object<a class="anchor" aria-label="anchor" href="#the-fbd-distribution-object"></a>
</h4>
<p>All the parameters of the FBD process have now been specified. The next step is to use these parameters to define the FBD tree prior distribution, which we will call <code>fbd_dist</code>. We will use this distribution to simulate a starting tree.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="va">fbd_dist</span> <span class="op">=</span> <span class="fu">dnFBDP</span><span class="op">(</span>origin<span class="op">=</span><span class="va">origin_time</span>, lambda<span class="op">=</span><span class="va">speciation_rate</span>, mu<span class="op">=</span><span class="va">extinction_rate</span>, psi<span class="op">=</span><span class="va">psi</span>, rho<span class="op">=</span><span class="va">rho</span>, taxa<span class="op">=</span><span class="va">taxa</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>There has been a good amount of prior work on Cinctans, and we are able to define the ingroup for the Cinctans. For our taxa without phylogenetic characters, this allows us to tell the model that those taxa belong inside the ingroup. The model can then marginalize over their exact placement, and use the age information to date the total ingroup.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">ingroup</span> <span class="op">=</span> <span class="fu">clade</span><span class="op">(</span><span class="st">"Ctenocystis_utahensis"</span>,<span class="st">"Gyrocystis_platessa"</span>,<span class="st">"Gyrocystis_testudiformis"</span>,<span class="st">"Gyrocystis_cruzae"</span>,<span class="st">"Gyrocystis_badulesiensis"</span>, <span class="st">"Gyrocystis_erecta"</span>,<span class="st">"Progyrocystis_disjuncta"</span>,<span class="st">"Protocinctus_mansillaensis"</span>,<span class="st">"Elliptocinctus_barrandei"</span>,<span class="st">"Elliptocinctus_vizcainoi"</span>,<span class="st">"Sucocystis_theronensis"</span>,<span class="st">"Sucocystis_bretoni"</span>,<span class="st">"Lignanicystis_barriosensis"</span>,<span class="st">"Undatacinctus_undata"</span>,<span class="st">"Sucocystis_acrofera"</span>,<span class="st">"Undatacinctus_quadricornuta"</span>,<span class="st">"Undatacinctus_melendezi"</span>,<span class="st">"Sotocinctus_ubaghsi"</span>,<span class="st">"Ludwigicinctus_truncatus"</span>,<span class="st">"Graciacystis_ambigua"</span>,<span class="st">"Nelegerocystis_ivantzovi"</span>,<span class="st">"Rozanovicystis_triangularis"</span>,<span class="st">"Davidocinctus_pembrokensis"</span><span class="op">)</span>
<span class="va">constraints</span> <span class="op">=</span> <span class="fu">v</span><span class="op">(</span><span class="va">ingroup</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Next, we will draw a starting tree out of this distribution. This will be a tree that is feasible given our model parameters, and consistent with our clade constraints.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">fbd_tree</span> <span class="op">~</span> <span class="fu">dnConstrainedTopology</span><span class="op">(</span><span class="va">fbd_dist</span>, constraints<span class="op">=</span><span class="va">constraints</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>We can look at this tree to ensure it exists and seems reasonable:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phylogeny</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/doRev.html">doRev</a></span><span class="op">(</span><span class="st">"fbd_tree"</span><span class="op">)</span>

<span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/plot.phylo.html" class="external-link">plot.phylo</a></span><span class="op">(</span><span class="va">phylogeny</span><span class="op">)</span></code></pre></div>
<p><img src="DiscreteMorphology_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="moves-on-the-tree-topology-and-node-ages">Moves on the Tree Topology and Node Ages<a class="anchor" aria-label="anchor" href="#moves-on-the-tree-topology-and-node-ages"></a>
</h4>
<p>Fossils require some special moves we have not yet seen in any of the tutorials. Firstly, there is <code>mvFNPR</code>, which makes changes to the tree with the knowledge that some tips may not be contemporaneous. <code>mvCollapseExpandFossilBranch</code> allows fossils to transiton between being sampled ancestors and tips. The <code>TimeSlide</code> moves allow us to sample values for node and origin ages.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvFNPR</span><span class="op">(</span><span class="va">fbd_tree</span>, weight<span class="op">=</span><span class="fl">15.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvCollapseExpandFossilBranch</span><span class="op">(</span><span class="va">fbd_tree</span>, <span class="va">origin_time</span>, weight<span class="op">=</span><span class="fl">6.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvNodeTimeSlideUniform</span><span class="op">(</span><span class="va">fbd_tree</span>, weight<span class="op">=</span><span class="fl">40.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvRootTimeSlideUniform</span><span class="op">(</span><span class="va">fbd_tree</span>, <span class="va">origin_time</span>, weight<span class="op">=</span><span class="fl">5.0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
</div>
<div class="section level4">
<h4 id="sampling-fossil-occurrence-ages">Sampling Fossil Occurrence Ages<a class="anchor" aria-label="anchor" href="#sampling-fossil-occurrence-ages"></a>
</h4>
<p>Next, we need to account for uncertainty in the age estimates of our fossils using the observed minimum and maximum stratigraphic ages provided in the file <code>cinctans_fossil_intervals.tsv</code>. These values are were obtained and cleaned from the Paleobiology Database. First, we read this file into a matrix called <code>intervals</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">intervals</span> <span class="op">=</span> <span class="fu">readDataDelimitedFile</span><span class="op">(</span>file<span class="op">=</span><span class="st">"cincta_fossil_intervals_FA.tsv"</span>, header<span class="op">=</span><span class="va">true</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Next, we loop over this matrix. For each fossil observation, we create a uniform random variable representing the likelihood. In this equation <span class="math inline">\(t_i\)</span> is the fossil age. <span class="math inline">\(a_i\)</span> and <span class="math inline">\(b_i\)</span> are the minimum and maximum edges of the fossil age range. And so, we treat the fossil age as being drawn from a uniform distribution between <span class="math inline">\((t_i - b_i)\)</span> and <span class="math inline">\((t_i - a_i)\)</span></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode rb"><code class="sourceCode ruby"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a>  intervals = readDataDelimitedFile(file=<span class="st">"cincta_fossil_intervals_FA.tsv"</span>, header=<span class="dv">true</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a>  <span class="kw">for</span>(i <span class="kw">in</span> <span class="dv">1</span><span class="st">:intervals</span>.size())</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a>  {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a>      taxon  = intervals[i][<span class="dv">1</span>]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a>      a_i = intervals[i][<span class="dv">2</span>]</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a>      b_i = intervals[i][<span class="dv">3</span>]</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a>      t[i] := tmrca(fbd_tree, clade(taxon))</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a>  </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a>      fossil[i] &lt;- a_i</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true"></a>      fossil[i] ~ dnSoftBoundUniformNormal(t[i] - b_i, t[i] - a_i, sd = <span class="dv">2</span>, p = <span class="fl">0.025</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true"></a>      fossil[i].clamp( <span class="dv">0</span> )</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true"></a>      </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true"></a>  }</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Finally, we add a move that samples the ages of the fossil nodes on the tree.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvFossilTimeSlideUniform</span><span class="op">(</span><span class="va">fbd_tree</span>, <span class="va">origin_time</span>, weight<span class="op">=</span><span class="fl">5.0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>We are also going to write the number of sampled ancestors in our analysis to our log files. You may be interested in this value.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">num_samp_anc</span> <span class="op">:=</span> <span class="fu">fbd_tree.numSampledAncestors</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="clock-model">Clock model<a class="anchor" aria-label="anchor" href="#clock-model"></a>
</h2>
<p>We will use the clock model we specified in the <a href="https://dwbapst.github.io/PaleoSoc_phylo_short_course_2019/articles/module_07_TripartiteModel2_clock_models/Clock_models_for_character_data.html" class="external-link">this tutorial on morphological clocks</a> again.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="va">ucln_mean</span> <span class="op">~</span> <span class="fu">dnExponential</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span>
    <span class="co"># sigma</span>
    <span class="va">ucln_sigma</span> <span class="op">~</span> <span class="fu">dnExponential</span><span class="op">(</span><span class="fl">3.0</span><span class="op">)</span> 
    <span class="co"># Set a deterministic node on sigma^2 </span>
    <span class="va">ucln_var</span> <span class="op">:=</span> <span class="va">ucln_sigma</span> <span class="op">*</span> <span class="va">ucln_sigma</span> 
    <span class="va">ucln_mu</span> <span class="op">:=</span> <span class="fu">ln</span><span class="op">(</span><span class="va">ucln_mean</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">ucln_var</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">ucln_mean</span>, lambda<span class="op">=</span><span class="fl">1.0</span>, tune<span class="op">=</span><span class="va">true</span>, weight<span class="op">=</span><span class="fl">4.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">ucln_sigma</span>, lambda<span class="op">=</span><span class="fl">0.5</span>, tune<span class="op">=</span><span class="va">true</span>, weight<span class="op">=</span><span class="fl">4.0</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_branches</span><span class="op">)</span><span class="op">{</span>
    <span class="va">branch_rate_var</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dnLognormal</span><span class="op">(</span><span class="va">ucln_mu</span>, <span class="va">ucln_sigma</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvScale</span><span class="op">(</span><span class="va">branch_rate_var</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lambda<span class="op">=</span><span class="fl">1</span>, tune<span class="op">=</span><span class="va">true</span>, weight<span class="op">=</span><span class="fl">2.0</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvVectorScale</span><span class="op">(</span><span class="va">branch_rate_var</span>,lambda<span class="op">=</span><span class="fl">1.0</span>,tune<span class="op">=</span><span class="va">true</span>,weight<span class="op">=</span><span class="fl">2.0</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">moves.append</span><span class="op">(</span><span class="fu">mvVectorSingleElementScale</span><span class="op">(</span><span class="va">branch_rate_var</span>,lambda<span class="op">=</span><span class="fl">30.0</span>,tune<span class="op">=</span><span class="va">true</span>,weight<span class="op">=</span><span class="fl">1.0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
</div>
<div class="section level2">
<h2 id="morphological-change-model">Morphological Change Model<a class="anchor" aria-label="anchor" href="#morphological-change-model"></a>
</h2>
<p>We will also use the morphology model defined in this <a href="https://dwbapst.github.io/PaleoSoc_phylo_short_course_2019/articles/module_06_TripartiteModel1_morph_change_models/RB_MCMC_Discrete_Morph.html" class="external-link">tree inference tutorial</a></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode rb"><code class="sourceCode ruby"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a>    alpha_morpho ~ dnUniform( <span class="dv">0</span>, 1E6 )</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true"></a>    rates_morpho := fnDiscretizeGamma( alpha_morpho, alpha_morpho, <span class="dv">4</span> )</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true"></a>    <span class="co">#Moves on the parameters of the Gamma distribution.</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true"></a>    moves.append(mvScale(alpha_morpho, lambda=<span class="dv">1</span>, weight=<span class="fl">2.0</span>))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true"></a>    n_max_states &lt;- <span class="dv">7</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true"></a>    idx = <span class="dv">1</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true"></a>    morpho_bystate[<span class="dv">1</span>] &lt;- morpho</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true"></a>    <span class="kw">for</span> (i <span class="kw">in</span> <span class="dv">2</span><span class="st">:n_max_states</span>) {</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true"></a>        <span class="co"># make local tmp copy of data</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true"></a>        <span class="co"># only keep character blocks with state space equal to size i</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true"></a>        morpho_bystate[i] &lt;- morpho</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true"></a>        morpho_bystate[i].setNumStatesPartition(i)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true"></a>        <span class="co"># get number of characters per character size wth i-sized states</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true"></a>        nc = morpho_bystate[i].nchar()</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true"></a>        <span class="co"># for non-empty character blocks</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true"></a>        <span class="kw">if</span> (nc &gt; <span class="dv">0</span>) {</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true"></a>            <span class="co"># make i-by-i rate matrix</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true"></a>            q[idx] &lt;- fnJC(i)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true"></a>    <span class="co"># create model of evolution for the character block</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true"></a>            m_morph[idx] ~ dnPhyloCTMC( tree=fbd_tree,</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true"></a>                                        Q=q[idx],</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true"></a>                                        nSites=nc,</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true"></a>                                        siteRates=rates_morpho,</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true"></a>                                        branchRates = branch_rate_var,</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true"></a>                                        type=<span class="st">"Standard"</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true"></a>    </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true"></a>            <span class="co"># attach the data</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true"></a>            m_morph[idx].clamp(morpho_bystate[i])</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true"></a>    </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true"></a>            <span class="co"># increment counter</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true"></a>            idx = idx + <span class="dv">1</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true"></a>            idx</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true"></a>        }</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true"></a>    }</span></code></pre></div>
<pre><code><span class="co">## [1] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span>
<span class="co">## [2] "2"                                                                                                               </span>
<span class="co">## [3] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span>
<span class="co">## [4] "3"                                                                                                               </span>
<span class="co">## [5] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span>
<span class="co">## [6] "4"                                                                                                               </span>
<span class="co">## [7] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span>
<span class="co">## [8] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span>
<span class="co">## [9] "NOTE: setNumStatesPartition() partitions by the maximum observed state, not the total number of observed states."</span></code></pre>
</div>
<div class="section level2">
<h2 id="running-our-analysis">Running our analysis<a class="anchor" aria-label="anchor" href="#running-our-analysis"></a>
</h2>
<p>As we have in prior sections, we will now initialize and execute our model. First, we create the model object that contains all of our character change, clock, and tree model parameters and priors.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">mymodel</span> <span class="op">=</span> <span class="fu">model</span><span class="op">(</span><span class="va">fbd_tree</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>Next, we inform RevBayes where we would like to write our sampled parameters.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="fu">monitors.append</span><span class="op">(</span><span class="fu">mnModel</span><span class="op">(</span>filename<span class="op">=</span><span class="st">"output/cinc_dated.log"</span>, printgen<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>And where we would like to write our trees.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="fu">monitors.append</span><span class="op">(</span><span class="fu">mnFile</span><span class="op">(</span>filename<span class="op">=</span><span class="st">"output/cinc_dated.trees"</span>, printgen<span class="op">=</span><span class="fl">10</span>, <span class="va">fbd_tree</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>We can also echo some facets to the screen</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="fu">monitors.append</span><span class="op">(</span><span class="fu">mnScreen</span><span class="op">(</span>printgen<span class="op">=</span><span class="fl">10</span>, <span class="va">num_samp_anc</span>, <span class="va">origin_time</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>And then we initialize the model.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R">
     <span class="va">mymcmc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">mcmc</a></span><span class="op">(</span><span class="va">mymodel</span>, <span class="va">monitors</span>, <span class="va">moves</span><span class="op">)</span></code></pre></div>
<p>And run it. In a real analysis, you would want to run this for far more than 1000 generations.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R">
    <span class="fu">mymcmc.run</span><span class="op">(</span>generations<span class="op">=</span><span class="fl">10000</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<p>And then we quit.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="fu"><a href="https://rdrr.io/r/base/quit.html" class="external-link">q</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
<div class="section level3">
<h3 id="running-the-estimation">Running the estimation<a class="anchor" aria-label="anchor" href="#running-the-estimation"></a>
</h3>
<p>We can automate convergence assessment using the R package convenience <span class="citation">(Fabreti, Höhna, and Schliep 2021)</span>. First, we will save our Rev session to a .Rev Script. In this case, we will set <code>use_quit = FALSE</code> because we typed the quit command in the above cell. We use the command <code>callRevFromTerminal</code> to run the file, then diagnose convergence with the convenience package. Because this is a longer computation, it is not directly run in this tutorial, but can be run on the user’s computer.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">convenience</span><span class="op">)</span>
<span class="fu"><a href="../reference/saveRev.html">saveRev</a></span><span class="op">(</span><span class="st">"mcmc_FBD.Rev"</span>, use_quit<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/callRevFromTerminal.html">callRevFromTerminal</a></span><span class="op">(</span><span class="st">"mcmc_FBD.Rev"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/convenience/man/checkConvergence.html" class="external-link">checkConvergence</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"output/"</span><span class="op">)</span></code></pre></div>
<p>We can also use RevGadgets <span class="citation">(Tribble et al. 2021)</span> to visualize our tree with a geological time scale. In this example, we use RevBayes to compute a summary tree, then export to RevGadets. Because this can be a long computation, the summarizing is not run here, but is provided. We can also use functions in ggplot2 <span class="citation">(Wickham and Hesselberth, n.d.)</span> to export figures. In this way, Revticulate can enable full reproducibility of results and graphics generation.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmt2/RevGadgets" class="external-link">RevGadgets</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="co">#doRev('trace = readTreeTrace("output/cinc_dated.trees", burnin=.25)</span>
<span class="co">#      mccTree(trace, "sample.tre")', timeout=60)</span>

<span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RevGadgets/man/readTrees.html" class="external-link">readTrees</a></span><span class="op">(</span><span class="st">"sample.tre"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
  |                                              
  |                                        |   0%
  |                                              
  |========================================| 100%</code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RevGadgets/man/plotFBDTree.html" class="external-link">plotFBDTree</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">tree</span>, 
            timeline <span class="op">=</span> <span class="cn">T</span>, 
            geo_units <span class="op">=</span> <span class="st">"epochs"</span>,
            time_bars <span class="op">=</span> <span class="cn">T</span>,
            tip_labels_italics <span class="op">=</span> <span class="cn">T</span>,
            tip_labels_remove_underscore <span class="op">=</span> <span class="cn">T</span>,
            tip_labels_size <span class="op">=</span> <span class="fl">3</span>, 
            node_pp <span class="op">=</span> <span class="cn">T</span>,
            tip_age_bars <span class="op">=</span> <span class="cn">T</span>,
            node_age_bars <span class="op">=</span> <span class="cn">T</span>, 
            age_bars_colored_by <span class="op">=</span> <span class="st">"posterior"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning: The tree contained negative edge lengths. If you want to ignore the edges,</span>
<span class="co">## you can set 'options(ignore.negative.edge=TRUE)', then re-run ggtree.</span></code></pre>
<pre><code><span class="co">## Warning in plotTreeFull(tree = tree, timeline = timeline, geo_units =</span>
<span class="co">## geo_units, : Plotting with default axis label (Age (Ma))</span></code></pre>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_output</span></code></pre></div>
<pre><code><span class="co">## Warning: Removed 1 rows containing missing values (geom_segment).</span></code></pre>
<p><img src="DiscreteMorphology_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"Cinctans_maximum_clade_credibility.png"</span>, <span class="va">tree_output</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Saving 7.29 x 4.51 in image</span></code></pre>
<pre><code><span class="co">## Warning: Removed 1 rows containing missing values (geom_segment).</span></code></pre>
<p><img src="Cinctans_maximum_clade_credibility.png" width="800"></p>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-allman08b">
<p>Allman, E. S., and J. A. Rhodes. 2008. “Identifying Evolutionary Trees and Substitution Parameters for the General Markov Model with Invariable Sites.” <em>Mathematical Biosciences</em> 211: 18–33.</p>
</div>
<div id="ref-fabreti2021">
<p>Fabreti, Luiza, Sebastian Höhna, and Klaus Schliep. 2021. <em>Lfabreti/Convenience: Integration with Zenodo</em> (version zenodo). Zenodo. <a href="https://doi.org/10.5281/zenodo.5520581" class="external-link">https://doi.org/10.5281/zenodo.5520581</a>.</p>
</div>
<div id="ref-Felsenstein1985a">
<p>Felsenstein, Joseph. 1985. “Phylogenies and the Comparative Method.” <em>The American Naturalist</em>, 1–15. <a href="https://doi.org/10.1086/284325" class="external-link">https://doi.org/10.1086/284325</a>.</p>
</div>
<div id="ref-Jukes1969">
<p>Jukes, TH, and CR Cantor. 1969. “Evolution of Protein Molecules.” <em>Mammalian Protein Metabolism</em> 3: 21–132. <a href="https://doi.org/10.1016/B978-1-4832-3211-9.50009-7" class="external-link">https://doi.org/10.1016/B978-1-4832-3211-9.50009-7</a>.</p>
</div>
<div id="ref-Lewis2001">
<p>Lewis, Paul O. 2001. “A Likelihood Approach to Estimating Phylogeny from Discrete Morphological Character Data.” <em>Systematic Biology</em> 50 (6): 913–25. <a href="https://doi.org/10.1080/106351501753462876" class="external-link">https://doi.org/10.1080/106351501753462876</a>.</p>
</div>
<div id="ref-tribble2021revgadgets">
<p>Tribble, Carrie M, William A Freyman, Michael J Landis, Jun Ying Lim, Joellë Barido-Sottani, Bjørn Tore Kopperud, Sebastian Hӧhna, and Michael R May. 2021. “RevGadgets: An R Package for Visualizing Bayesian Phylogenetic Analyses from Revbayes.” <em>Methods in Ecology and Evolution</em>.</p>
</div>
<div id="ref-wickham1pkgdown">
<p>Wickham, Hadley, and Jay Hesselberth. n.d. “Pkgdown: Make Static Html Documentation for a Package, 2018.” <em>URL Https://CRAN. R-Project. Org/Package= Pkgdown. R Package Version</em> 1 (0): 560.</p>
</div>
<div id="ref-Wright2014">
<p>Wright, April M, and David M Hillis. 2014. “Bayesian Analysis Using a Simple Likelihood Model Outperforms Parsimony for Estimation of Phylogeny from Discrete Morphological Data.” <em>PLoS One</em> 9 (10): e109210. <a href="https://doi.org/10.1371/journal.pone.0109210" class="external-link">https://doi.org/10.1371/journal.pone.0109210</a>.</p>
</div>
<div id="ref-Wright2016">
<p>Wright, April M., Graeme T. Lloyd, and David M. Hillis. 2016. “Modeling Character Change Heterogeneity in Phylogenetic Analyses of Morphology Through the Use of Priors.” <em>Systematic Biology</em> 65 (4): 602–11. <a href="https://doi.org/10.1093/sysbio/syv122" class="external-link">https://doi.org/10.1093/sysbio/syv122</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Caleb Charpentier, April Wright.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
